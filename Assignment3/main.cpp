#include <cstdio>
#include "pico/stdlib.h"
#include "hardware/i2c.h"
#include "ssd1306.h"

#define BUFFER_SIZE 64
// LEDs
#define LED_D3 20
#define LED_D2 21
#define LED_D1 22
// I2C1
#define I2C_SDA 14
#define I2C_SCL 15
#define BAUD_RATE 400000

int main() {

    /* Buffer for elapsed time */
    char msg_buffer[BUFFER_SIZE];

    /* Initialize LED pin */
    gpio_init(LED_D3);
    gpio_set_dir(LED_D3, GPIO_OUT);
    gpio_init(LED_D2);
    gpio_set_dir(LED_D2, GPIO_OUT);
    gpio_init(LED_D1);
    gpio_set_dir(LED_D1, GPIO_OUT);

    /* Initialize I2C */
    i2c_init(i2c1, BAUD_RATE);
    gpio_set_function(I2C_SCL, GPIO_FUNC_I2C);
    gpio_set_function(I2C_SDA, GPIO_FUNC_I2C);
    ssd1306 display(i2c1);

    /* Initialize chosen serial port */
    stdio_init_all();

    /* Start the time */
    uint64_t start_time = time_us_64();

    /* Clears OLED */
    display.fill(0);
    display.show();

    /* some drawing */
    const unsigned char drawing[] = {
            // font edit begin : monovlsb : 39 : 39 : 39
            0xFF, 0x07, 0x03, 0x03, 0x03, 0x03, 0x03, 0x01,
            0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
            0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
            0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
            0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xC3, 0xFF,
            0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0x30,
            0x18, 0x08, 0x08, 0x08, 0x18, 0x30, 0xE0, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0xF0, 0x10, 0x10, 0x08, 0x08, 0x08, 0x08, 0x08,
            0x18, 0xF0, 0xC0, 0x00, 0x00, 0xFF, 0xFF, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x02, 0x03, 0x02, 0x02,
            0x02, 0x02, 0x02, 0x02, 0x02, 0x03, 0x03, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03,
            0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
            0x03, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x0C, 0x38, 0x60, 0xC0, 0x80, 0x80, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80,
            0x80, 0xC0, 0x40, 0x20, 0x08, 0x08, 0x00, 0x00,
            0x00, 0x00, 0x00, 0xFF, 0x7F, 0xF0, 0x40, 0x40,
            0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0xC0, 0xC0,
            0xE0, 0xE0, 0x60, 0x40, 0xC0, 0xC0, 0x81, 0x83,
            0x82, 0x82, 0x82, 0x82, 0x83, 0x81, 0x81, 0x80,
            0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x40, 0x40,
            0x40, 0x40, 0xBD
            // font edit end
    };

    /* Loop forever */
    while (true) {
        /* Blink LEDs */
        for (uint8_t i = 7; i >= 0; i--) {
            /* Blink LEDs */
            uint8_t led_state = i & 0x01;       // Mask to get 1st LSB (masking)
            gpio_put(LED_D1, led_state);        // D1 blinks 4 times per second

            led_state = i & 0x02;               // Mask to get 2nd LSB
            gpio_put(LED_D2, led_state);        // D2 blinks 2 times per second

            led_state = i & 0x04;               // Mask to get 3rd LSB
            gpio_put(LED_D3, led_state);        // D3 blinks 1 time per second
            sleep_ms(125);

            /* Calculate passed time */
            uint64_t current_time = time_us_64();
            uint64_t elapsed_seconds = (current_time - start_time) / 1e6;
            sprintf(msg_buffer, "Time: %llu s", elapsed_seconds);

            /* Update OLED */
            display.fill(0);
            display.text(msg_buffer, 0, 0);     // Display elapsed time

            mono_vlsb rb(drawing, 39, 39);      // Display drawing
            display.blit(rb, 16, 16);            // Set position for drawing
            display.show();
        }
    }
    return 0 ;
}
